<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Airbnb Embeds with User Ratings (1–5)</title>
  <style>
    .embed-row { margin-bottom: 40px; }
    .user-rating-row { margin: 8px 0; }
    .star {
      font-size: 1.5em;
      color: #ccc;
      cursor: pointer;
      transition: color 0.2s;
      border: none;
      background: none;
      padding: 0 2px;
    }
    .star.selected {
      color: #ffb400;
    }
    .username {
      display: inline-block;
      width: 70px;
      font-weight: bold;
    }
    .votes-summary {
      margin-top: 5px;
      font-size: 0.95em;
      color: #555;
    }
    #status {
      padding: 10px 18px;
      margin-bottom: 20px;
      border-radius: 5px;
      font-size: 1.1em;
      display: inline-block;
      min-width: 200px;
    }
    #status.loading { background: #e7f3fe; color: #31708f; border: 1px solid #bce8f1;}
    #status.success { background: #e6ffed; color: #2e7d32; border: 1px solid #b2dfdb;}
    #status.error { background: #ffeaea; color: #c62828; border: 1px solid #f44336;}
  </style>
</head>
<body>
  <div class="container mt-4">
    <div id="status" class="loading">Loading…</div>
    <h2>Airbnb Listings</h2>
    <div id="embeds"></div>
  </div>
  <script>
    let API_KEY = '';
    let ACCESS_KEY = '';
    let BIN_ID = '';
    let API_URL = '';

    let users = [];
    let embeds = [];
    let listingIds = [];
    let rankings = []; // Array of { listing_id, votes: { user: rating } }

    function setStatus(message, type = "loading") {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = type;
    }

    function getHeaders() {
      const headers = {
        'Content-Type': 'application/json',
        'X-Master-Key': API_KEY
      };
      if (ACCESS_KEY) {
        headers['X-ACCESS-KEY'] = ACCESS_KEY;
      }
      return headers;
    }

    function averageRating(arr) {
      const rated = arr.filter(x => x > 0);
      if (rated.length === 0) return 0;
      return rated.reduce((a,b) => a+b, 0) / rated.length;
    }

    // Update JSONBin.io on rate only if a new vote is registered
    window.rate = async function(listingId, user, stars) {
      const idx = rankings.findIndex(r => r.listing_id === listingId);
      if (idx === -1) return;
      const previousVote = rankings[idx].votes[user] || 0;
      if (previousVote === stars) {
        setStatus("No change: vote is the same as before.", "success");
        return;
      }
      rankings[idx].votes[user] = stars;

      // Render embeds directly here
      renderEmbeds();

      setStatus("Saving vote to JSONBin…", "loading");
      try {
        const response = await fetch(API_URL, {
          method: 'PUT',
          headers: getHeaders(),
          body: JSON.stringify({ rankings })
        });
        if (response.ok) {
          setStatus(`Vote saved! (status ${response.status} ${response.statusText})`, "success");
        } else {
          setStatus(`Error saving vote (status ${response.status} ${response.statusText})`, "error");
        }
      } catch (err) {
        setStatus("Failed to save rankings to JSONBin.io", "error");
        console.error('Failed to save rankings:', err);
      }
    };

    // Main app start
    Promise.all([
      fetch('API_KEY.txt').then(apiKeyResponse => apiKeyResponse.text()),
      fetch('ACCESS_KEY.txt').then(accessKeyResponse => accessKeyResponse.text()),
      fetch('BIN_ID.txt').then(binIdResponse => binIdResponse.text())
    ]).then(([apiKeyText, accessKeyText, binIdText]) => {
      API_KEY = apiKeyText.trim();
      ACCESS_KEY = accessKeyText.trim();
      BIN_ID = binIdText.trim();
      API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
      setStatus("Loading data from JSONBin…", "loading");

      Promise.all([
        fetch('users.txt').then(usersResponse => usersResponse.text()),
        fetch('urls.txt').then(urlsResponse => urlsResponse.text()),
        fetch(API_URL, { headers: getHeaders() })
          .then(rankingsResponse => {
            setStatus(`Loaded rankings (status ${rankingsResponse.status} ${rankingsResponse.statusText})`, 
              rankingsResponse.ok ? "success" : "error");
            return rankingsResponse.json();
          })
          .then(rankingsData => rankingsData?.record?.rankings || [])
          .catch(err => {
            setStatus("Could not load rankings from JSONBin", "error");
            return [];
          })
      ]).then(([usersText, embedsText, savedRankings]) => {
        users = usersText.split('\n').map(u => u.trim()).filter(Boolean);
        embeds = embedsText.split('\n').map(line => line.trim()).filter(Boolean);

        // Extract listing IDs from embeds
        listingIds = embeds.map(embedHtml => {
          const match = embedHtml.match(/data-id="(\d+)"/);
          return match ? match[1] : null;
        });

        // Build rankings array: one object per listing
        rankings = listingIds.map((listingId, idx) => {
          const existing = savedRankings.find(r => r.listing_id === listingId);
          let votes = {};
          users.forEach(user => {
            votes[user] = existing && existing.votes && typeof existing.votes[user] !== 'undefined'
              ? existing.votes[user]
              : 0;
          });
          return { listing_id: listingId, votes };
        });

        setStatus("Loaded all data successfully.", "success");

        // Render embeds directly here
        renderEmbeds();
      });
    });

    // This function is now called directly after data load and after each vote
    function renderEmbeds() {
      const container = document.getElementById('embeds');
      container.innerHTML = '';
      embeds.forEach((embedHtml, i) => {
        const div = document.createElement('div');
        div.className = "embed-row";
        div.innerHTML = embedHtml;
        users.forEach((u, userIdx) => {
          const row = document.createElement('div');
          row.className = 'user-rating-row';
          const userVote = rankings[i].votes[u] || 0;
          row.innerHTML = `<span class="username">${u}:</span> ` +
            [1,2,3,4,5].map(star =>
              `<button class="star${userVote >= star ? ' selected' : ''}" 
                onclick="rate('${rankings[i].listing_id}','${u}',${star})"
                title="${star} star${star>1?'s':''}">
                &#9733;
              </button>`
            ).join(' ') +
            `<span id="user-rating-${i}-${userIdx}" style="margin-left:10px;">${userVote ? userVote + '★' : ''}</span>`;
          div.appendChild(row);
        });
        const avg = averageRating(Object.values(rankings[i].votes));
        const summary = document.createElement('div');
        summary.className = "votes-summary";
        summary.id = `votes-${i}`;
        summary.textContent = `Average rating: ${avg > 0 ? avg.toFixed(2) : 'N/A'}`;
        div.appendChild(summary);
        container.appendChild(div);
      });

      // Reload Airbnb embed script to render embeds properly
      const oldScript = document.querySelector('script[src*="airbnb_jssdk"]');
      if (oldScript) oldScript.remove();
      const script = document.createElement('script');
      script.src = "https://www.airbnb.com/embeddable/airbnb_jssdk";
      script.async = true;
      document.body.appendChild(script);
    }
  </script>
</body>
</html>

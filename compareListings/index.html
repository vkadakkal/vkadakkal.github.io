<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Airbnb Embeds with User Voting</title>
  <style>
    .embed-row { margin-bottom: 40px; }
    .rank-buttons { margin: 10px 0; }
    button[disabled] { opacity: 0.6; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h2>Airbnb Listings</h2>
    <div id="embeds"></div>
  </div>
  <script>
    let users = [];
    let embeds = [];
    let rankings = []; // rankings[listingIdx][userIdx] = true/false

    // Load users and embeds, then render
    Promise.all([
      fetch('users.txt').then(usersResponse => usersResponse.text()),
      fetch('urls.txt').then(urlsResponse => urlsResponse.text())
    ]).then(([usersText, embedsText]) => {
      users = usersText.split('\n').map(u => u.trim()).filter(Boolean);
      embeds = embedsText.split('\n').map(line => line.trim()).filter(Boolean);
      rankings = embeds.map(() => Array(users.length).fill(false));
      renderEmbeds();
    });

    function renderEmbeds() {
      const container = document.getElementById('embeds');
      container.innerHTML = '';
      embeds.forEach((embedHtml, idx) => {
        const div = document.createElement('div');
        div.className = "embed-row";
        // Add Airbnb embed
        div.innerHTML = embedHtml;

        // Add ranking buttons
        const rankDiv = document.createElement('div');
        rankDiv.className = "rank-buttons";
        rankDiv.innerHTML =
          users.map((user, userIdx) =>
            `<button id="rank-btn-${idx}-${userIdx}" onclick="rank(${idx},${userIdx})" ${rankings[idx][userIdx] ? 'disabled' : ''}>
              ${user} ${rankings[idx][userIdx] ? '✔️' : 'Rank'}
            </button>`
          ).join(' ') +
          ` <span id="votes-${idx}">Votes: ${rankings[idx].filter(Boolean).length}</span>`;
        div.appendChild(rankDiv);

        container.appendChild(div);
      });
    }

    // Expose rank function globally
    window.rank = function(listingIdx, userIdx) {
      rankings[listingIdx][userIdx] = true;
      // Update only the buttons and vote count for this embed
      users.forEach((user, u) => {
        const btn = document.getElementById(`rank-btn-${listingIdx}-${u}`);
        if (btn) {
          btn.disabled = rankings[listingIdx][u];
          btn.innerHTML = `${user} ${rankings[listingIdx][u] ? '✔️' : 'Rank'}`;
        }
      });
      // Update vote count
      const votes = rankings[listingIdx].filter(Boolean).length;
      document.getElementById(`votes-${listingIdx}`).textContent = `Votes: ${votes}`;
    };
  </script>
  <!-- Only include the Airbnb embed script ONCE for all embeds -->
  <script async src="https://www.airbnb.com/embeddable/airbnb_jssdk"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Airbnb Embeds with User Ratings (1–5)</title>
  <style>
    .embed-row { margin-bottom: 40px; }
    .user-rating-row { margin: 8px 0; }
    .star {
      font-size: 1.5em;
      color: #ccc;
      cursor: pointer;
      transition: color 0.2s;
      border: none;
      background: none;
      padding: 0 2px;
    }
    .star.selected, .star:hover, .star.selected ~ .star {
      color: #ffb400;
    }
    .username {
      display: inline-block;
      width: 70px;
      font-weight: bold;
    }
    .votes-summary {
      margin-top: 5px;
      font-size: 0.95em;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h2>Airbnb Listings</h2>
    <div id="embeds"></div>
  </div>
  <script>
    let API_KEY = '';
    let BIN_ID = '';
    let API_URL = '';

    let users = [];
    let embeds = [];
    let listingIds = [];
    let rankings = []; // Array of { listing_id, votes: { user: rating } }

    // Fetch API_KEY and BIN_ID first, then proceed
    Promise.all([
      fetch('API_KEY.txt').then(apiKeyResponse => apiKeyResponse.text()),
      fetch('BIN_ID.txt').then(binIdResponse => binIdResponse.text())
    ]).then(([apiKeyText, binIdText]) => {
      API_KEY = apiKeyText.trim();
      BIN_ID = binIdText.trim();
      API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
      startApp();
    });

    function startApp() {
      Promise.all([
        fetch('users.txt').then(usersResponse => usersResponse.text()),
        fetch('urls.txt').then(urlsResponse => urlsResponse.text()),
        fetch(API_URL, { headers: { 'X-Master-Key': API_KEY } })
          .then(rankingsResponse => rankingsResponse.json())
          .then(rankingsData => rankingsData?.record?.rankings || [])
          .catch(() => [])
      ]).then(([usersText, embedsText, savedRankings]) => {
        users = usersText.split('\n').map(u => u.trim()).filter(Boolean);
        embeds = embedsText.split('\n').map(line => line.trim()).filter(Boolean);

        // Extract listing IDs from embeds
        listingIds = embeds.map(embedHtml => {
          const match = embedHtml.match(/data-id="(\d+)"/);
          return match ? match[1] : null;
        });

        // Build rankings array: one object per listing
        rankings = listingIds.map((listingId, idx) => {
          // Try to find existing ranking for this listing
          const existing = savedRankings.find(r => r.listing_id === listingId);
          let votes = {};
          users.forEach(user => {
            votes[user] = existing && existing.votes && typeof existing.votes[user] !== 'undefined'
              ? existing.votes[user]
              : 0;
          });
          return { listing_id: listingId, votes };
        });

        renderEmbeds();
      });
    }

    function renderEmbeds() {
      const container = document.getElementById('embeds');
      container.innerHTML = '';
      embeds.forEach((embedHtml, idx) => {
        const div = document.createElement('div');
        div.className = "embed-row";
        div.innerHTML = embedHtml;

        // User rating rows
        users.forEach((user, userIdx) => {
          const row = document.createElement('div');
          row.className = 'user-rating-row';
          const userVote = rankings[idx].votes[user] || 0;
          row.innerHTML = `<span class="username">${user}:</span> ` +
            [1,2,3,4,5].map(star =>
              `<button class="star${userVote >= star ? ' selected' : ''}" 
                onclick="rate('${rankings[idx].listing_id}','${user}',${star})"
                title="${star} star${star>1?'s':''}">
                &#9733;
              </button>`
            ).join(' ') +
            `<span id="user-rating-${idx}-${userIdx}" style="margin-left:10px;">${userVote ? userVote + '★' : ''}</span>`;
          div.appendChild(row);
        });

        // Votes summary
        const avg = averageRating(Object.values(rankings[idx].votes));
        const summary = document.createElement('div');
        summary.className = "votes-summary";
        summary.id = `votes-${idx}`;
        summary.textContent = `Average rating: ${avg > 0 ? avg.toFixed(2) : 'N/A'}`;
        div.appendChild(summary);

        container.appendChild(div);
      });
    }

    // Update JSONBin.io on rate
    window.rate = async function(listingId, user, stars) {
      // Find the index for this listing
      const idx = rankings.findIndex(r => r.listing_id === listingId);
      if (idx === -1) return;
      rankings[idx].votes[user] = stars;
      renderEmbeds();
      try {
        await fetch(API_URL, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': API_KEY
          },
          body: JSON.stringify({ rankings })
        });
      } catch (err) {
        alert('Failed to save rankings to JSONBin.io');
        console.error('Failed to save rankings:', err);
      }
    };

    function averageRating(arr) {
      const rated = arr.filter(x => x > 0);
      if (rated.length === 0) return 0;
      return rated.reduce((a,b) => a+b, 0) / rated.length;
    }
  </script>
  <script async src="https://www.airbnb.com/embeddable/airbnb_jssdk"></script>
</body>
</html>

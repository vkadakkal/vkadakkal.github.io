<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Airbnb Embeds with Persistent Voting</title>
  <style>
    .embed-row { margin-bottom: 40px; }
    .rank-buttons { margin: 10px 0; }
    button[disabled] { opacity: 0.6; }
    #exportBtn { margin: 20px; padding: 10px; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h2>Airbnb Listings</h2>
    <button id="exportBtn" onclick="exportRankings()">Export Rankings to File</button>
    <div id="embeds"></div>
  </div>
  <script>
    let users = [];
    let embeds = [];
    let rankings = []; // rankings[listingIdx][userIdx] = true/false

    // Load users, embeds, and rankings
    Promise.all([
      fetch('users.txt').then(r => r.text()),
      fetch('urls.txt').then(r => r.text())
    ]).then(([usersText, embedsText]) => {
      users = usersText.split('\n').map(u => u.trim()).filter(Boolean);
      embeds = embedsText.split('\n').map(line => line.trim()).filter(Boolean);
      
      // Load rankings from localStorage or initialize
      const savedRankings = localStorage.getItem('rankings');
      rankings = savedRankings 
        ? JSON.parse(savedRankings) 
        : embeds.map(() => Array(users.length).fill(false));
      
      renderEmbeds();
    });

    function renderEmbeds() {
      const container = document.getElementById('embeds');
      container.innerHTML = '';
      embeds.forEach((embedHtml, idx) => {
        const div = document.createElement('div');
        div.className = "embed-row";
        div.innerHTML = embedHtml;

        const rankDiv = document.createElement('div');
        rankDiv.className = "rank-buttons";
        rankDiv.innerHTML =
          users.map((user, userIdx) =>
            `<button id="rank-btn-${idx}-${userIdx}" onclick="rank(${idx},${userIdx})" ${rankings[idx][userIdx] ? 'disabled' : ''}>
              ${user} ${rankings[idx][userIdx] ? '✔️' : 'Rank'}
            </button>`
          ).join(' ') +
          ` <span id="votes-${idx}">Votes: ${rankings[idx].filter(Boolean).length}</span>`;
        div.appendChild(rankDiv);
        container.appendChild(div);
      });
    }

    // Save to localStorage on rank
    window.rank = function(listingIdx, userIdx) {
      rankings[listingIdx][userIdx] = true;
      localStorage.setItem('rankings', JSON.stringify(rankings));
      updateButtonsAndVotes(listingIdx);
    };

    function updateButtonsAndVotes(listingIdx) {
      users.forEach((user, u) => {
        const btn = document.getElementById(`rank-btn-${listingIdx}-${u}`);
        if (btn) {
          btn.disabled = rankings[listingIdx][u];
          btn.innerHTML = `${user} ${rankings[listingIdx][u] ? '✔️' : 'Rank'}`;
        }
      });
      document.getElementById(`votes-${listingIdx}`).textContent = 
        `Votes: ${rankings[listingIdx].filter(Boolean).length}`;
    }

    // Export rankings to a downloadable file
    function exportRankings() {
      const data = rankings.map((listing, idx) => 
        `Listing ${idx + 1}: ${embeds[idx]} | Votes: ${listing.filter(Boolean).length}`
      ).join('\n');
      const blob = new Blob([data], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'rank.txt';
      a.click();
      window.URL.revokeObjectURL(url);
    }
  </script>
  <script async src="https://www.airbnb.com/embeddable/airbnb_jssdk"></script>
</body>
</html>

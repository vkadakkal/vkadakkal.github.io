<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Airbnb Embeds with JSONBin Voting</title>
  <style>
    .embed-row { margin-bottom: 40px; }
    .rank-buttons { margin: 10px 0; }
    button[disabled] { opacity: 0.6; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h2>Airbnb Listings</h2>
    <div id="embeds"></div>
  </div>
  <script>
    // Replace these with your values
    const API_KEY = '$2a$10$F71JVe.NcK4dd9SWiwm/YeIVSY4JvtHESddyxostQVlwgUTpdVU5S';
    const BIN_ID = '68393c8f8561e97a501d5c1a';
    const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    let users = [];
    let embeds = [];
    let rankings = [];

    // Fetch initial data
    Promise.all([
      fetch('users.txt').then(r => r.text()),
      fetch('urls.txt').then(r => r.text()),
      fetch(API_URL, { headers: { 'X-Master-Key': API_KEY } })
        .then(r => r.json())
        .then(data => data?.record?.rankings || [])
        .catch(() => []) // Fallback if bin doesn’t exist
    ]).then(([usersText, embedsText, savedRankings]) => {
      users = usersText.split('\n').map(u => u.trim()).filter(Boolean);
      embeds = embedsText.split('\n').map(line => line.trim()).filter(Boolean);
      rankings = savedRankings.length === embeds.length 
        ? savedRankings 
        : embeds.map(() => Array(users.length).fill(false));
      renderEmbeds();
    });

    function renderEmbeds() {
      const container = document.getElementById('embeds');
      container.innerHTML = '';
      embeds.forEach((embedHtml, idx) => {
        const div = document.createElement('div');
        div.className = "embed-row";
        div.innerHTML = embedHtml;

        const rankDiv = document.createElement('div');
        rankDiv.className = "rank-buttons";
        rankDiv.innerHTML =
          users.map((user, userIdx) =>
            `<button id="rank-btn-${idx}-${userIdx}" onclick="rank(${idx},${userIdx})" ${rankings[idx][userIdx] ? 'disabled' : ''}>
              ${user} ${rankings[idx][userIdx] ? '✔️' : 'Rank'}
            </button>`
          ).join(' ') +
          ` <span id="votes-${idx}">Votes: ${rankings[idx].filter(Boolean).length}</span>`;
        div.appendChild(rankDiv);
        container.appendChild(div);
      });
    }

    // Update JSONBin.io on rank
    window.rank = async function(listingIdx, userIdx) {
      rankings[listingIdx][userIdx] = true;
      updateButtonsAndVotes(listingIdx);
      
      try {
        await fetch(API_URL, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': API_KEY
          },
          body: JSON.stringify({ rankings })
        });
      } catch (err) {
        console.error('Failed to save rankings:', err);
      }
    };

    function updateButtonsAndVotes(listingIdx) {
      users.forEach((user, u) => {
        const btn = document.getElementById(`rank-btn-${listingIdx}-${u}`);
        if (btn) {
          btn.disabled = rankings[listingIdx][u];
          btn.innerHTML = `${user} ${rankings[listingIdx][u] ? '✔️' : 'Rank'}`;
        }
      });
      document.getElementById(`votes-${listingIdx}`).textContent = 
        `Votes: ${rankings[listingIdx].filter(Boolean).length}`;
    }
  </script>
  <script async src="https://www.airbnb.com/embeddable/airbnb_jssdk"></script>
</body>
</html>
